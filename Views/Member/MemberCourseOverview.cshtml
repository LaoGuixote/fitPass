@model fitPass.ViewModels.CoursrOverview.CourseOverview

<style>

    .btn-cancel{
    background-color: #6c757d;
    color: white;
    font-size: 14px;
    font-weight: 500;
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    }
</style>

@{
    ViewData["Title"] = "我的課程";

    string TimeSlotToString(int slot) => $"{slot + 5}:00 - {slot + 6}:00";
    string FormatDate(DateOnly date) => date.ToString("yyyy-MM-dd");
    string DailyToWeek(int daily)
    {
        string[] chineseNumber = ["一", "二", "三", "四", "五", "六", "日"];
        return daily >= 1 && daily <= 7 ? $"每週{chineseNumber[daily - 1]} " : "請傳入1~7";
    }

    var groupFilter = Context.Request.Query["groupFilter"].ToString();
    var privateFilter = Context.Request.Query["privateFilter"].ToString();
    var keyword = Context.Request.Query["keyword"].ToString();
    var privateDate = Context.Request.Query["privateDate"].ToString();
    var privateCoach = Context.Request.Query["privateCoach"].ToString();
}

<div class="d-flex justify-content-between mb-1">
    <h2 class="text-title-xl">我的團課</h2>
    <div class="mb-1">
        <select id="groupFilter" class="form-select">
            @if (groupFilter == "active")
            {
                        <option value="active" selected>未到期</option>
            }
            else
            {
                        <option value="active">未到期</option>
            }
            @if (groupFilter == "expired")
            {
                        <option value="expired" selected>已到期</option>
            }
            else
            {
                        <option value="expired">已到期</option>
            }
            @if (groupFilter == "all")
            {
                        <option value="all" selected>全部</option>

            }
            else
            {
                        <option value="all">全部</option>
            }
        </select>
    </div>
</div>

<div class="d-flex align-items-center justify-content-between mb-3">
    <input type="text" id="keyword" class="form-control me-2" style="flex: 1;" value="@keyword" placeholder="搜尋課程名稱">

    <button id="courseSearchCancel" class="btn-cancel">清除</button>
</div>

<div class="row">
    @foreach (var gc in Model.GroupCourses)
    {
        var imageBase64 = gc.CourseImage != null ? Convert.ToBase64String(gc.CourseImage) : null;
        var imageSrc = imageBase64 != null
            ? $"data:image/jpeg;base64,{imageBase64}"
            : Url.Content("~/images/default.png");

            <div class="col-12">
                <div class="fitpass-card mb-2 d-block text-decoration-none text-dark d-flex align-items-center">
                    <a href="@Url.Action("GroupCourseDetail", "CourseSchedules", new { id = gc.CourseId })" style="text-decoration: none;">
                    <img src="@imageSrc" class="me-3 rounded" alt="課程圖片" style="width: 70px; heigh: 7px; object-fit: contain" />
                    </a>
                    <div>
                        <h5 class="text-title-md fw-bold">@gc.Title</h5>
                        <span class="text-info-sm">
                        @(gc.ClassStartDate.HasValue ? FormatDate(gc.ClassStartDate.Value) : "未定")~@(gc.ClassEndDate.HasValue ? FormatDate(gc.ClassEndDate.Value) : "未定")<br />
                            課程時間：@(gc.ClassTimeDaily.HasValue ? DailyToWeek(gc.ClassTimeDaily.Value) + TimeSlotToString(gc.ClassTimeDaily.Value) : "未定")<br />
                            教練：@gc.CoachName
                        </span>
                    </div>
                </div>
            </div>
    }
</div>

<hr />

<div class="d-flex justify-content-between align-items-center mb-2">
<h2 class="text-title-xl mt-1">我的預約</h2>

<div>
    <input type="date" id="privateDate" class="form-control " style="width: 8.125rem;" value="@privateDate">
</div>

    <div>
        <select id="privateFilter" class="form-select ">
            @if (privateFilter == "active")
            {
                        <option value="active" selected>未到期</option>
            }
            else
            {
                        <option value="active">未到期</option>
            }
            @if (privateFilter == "expired")
            {
                        <option value="expired" selected>已到期</option>
            }
            else
            {
                        <option value="expired">已到期</option>
            }
            @if (privateFilter == "all")
            {
                            <option value="all" selected>全部</option>

            }
            else
            {
                            <option value="all">全部</option>
            }
        </select>
    </div>

</div>


<div class="d-flex align-items-center justify-content-between mb-3">
    <input type="text" id="privateCoach" class="form-control me-2" style="flex: 1;" value="@privateCoach" placeholder="搜尋教練姓名">

    <button id="coachSearchCancel" class="btn-cancel">清除</button>
</div>

<table class="table table-secondary table-striped">
    <thead>
        <tr>
            <th>教練</th>
            <th>日期</th>
            <th>時段</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var s in Model.PrivateCourses)
        {
                    <tr>
                        <td class="align-middle">@s.CoachName</td>
                        <td class="align-middle">@FormatDate(s.Date)</td>
                        <td class="d-flex align-items-center justify-content-between">
                    @TimeSlotToString(s.TimeSlot)

                    @* 顯示條件：預約狀態是 1 且未過期 *@
                    @if (s.Status == 1 && s.Date >= DateOnly.FromDateTime(DateTime.Today))
                    {
                                        <button type="button" 
                                                class="btn btn-sm btn-danger ms-2" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#cancelConfirmModal"
                                                data-session-id="@s.SessionId">
                                            取消預約
                                        </button>
                    }
                        </td>
                    </tr>
        }
    </tbody>
</table>

<div class="qrcode-fixed-bar d-grid">
    <button class="btn btn-green py-3" data-bs-toggle="modal" data-bs-target="#qrcodeModal" id="courseCalendar">
        課程行事曆
    </button>
</div>

<div class="modal fade" id="cancelConfirmModal" tabindex="-1" aria-labelledby="cancelConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelConfirmModalLabel">確認取消預約</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p>確定要取消預約嗎？</p>
                <p class="text-muted">取消後將退還 299 點數至您的帳戶</p>
            </div>
            <div class="modal-footer">
                <form id="cancelForm" asp-action="CancelPrivate" asp-controller="Member" method="post" style="display: inline;">
                    <input type="hidden" name="id" id="cancelSessionId" />
                    <button type="submit" class="btn btn-danger">確認取消</button>
                </form>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">返回</button>
            </div>
        </div>
    </div>
</div>

<script>
    function updateUrlAndSearch() {
        const groupFilter = document.getElementById("groupFilter").value;
        const privateFilter = document.getElementById("privateFilter").value;
        const keyword = document.getElementById("keyword").value;
        const privateDate = document.getElementById("privateDate").value;
        const privateCoach = document.getElementById("privateCoach").value;

        const url = new URL(window.location.href.split('?')[0]);

    if (groupFilter) url.searchParams.set("groupFilter", groupFilter);
    else url.searchParams.delete("groupFilter");

    if (privateFilter) url.searchParams.set("privateFilter", privateFilter);
    else url.searchParams.delete("privateFilter");

    if (keyword) url.searchParams.set("keyword", keyword);
    else url.searchParams.delete("keyword");

    if (privateDate) url.searchParams.set("privateDate", privateDate);
    else url.searchParams.delete("privateDate");

    if (privateCoach) url.searchParams.set("privateCoach", privateCoach);
    else url.searchParams.delete("privateCoach");


        window.location.href = url.toString();
    }

    document.getElementById("groupFilter").addEventListener("change", updateUrlAndSearch);
    document.getElementById("privateFilter").addEventListener("change", updateUrlAndSearch);
    document.getElementById("privateDate").addEventListener("change", updateUrlAndSearch);
    document.getElementById("keyword").addEventListener("keydown", function (e) {
        if(e.key == "Enter"){
            updateUrlAndSearch();
        }
    });
    document.getElementById("privateCoach").addEventListener("keydown", function (e) {
        if(e.key == "Enter"){
            updateUrlAndSearch();
        }
    });

    document.getElementById("courseSearchCancel").addEventListener("click", function () {
        document.getElementById("keyword").value = "";
        updateUrlAndSearch(); 
    });

    document.getElementById("coachSearchCancel").addEventListener("click", function () {
        document.getElementById("privateCoach").value = "";
        updateUrlAndSearch(); 
    });

    $("#courseCalendar").on("click", function(){
         window.location.href = "/CourseSchedules/MobileSchedule";
    });

      document.addEventListener('DOMContentLoaded', function() {
        const cancelConfirmModal = document.getElementById('cancelConfirmModal');

        cancelConfirmModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const sessionId = button.getAttribute('data-session-id');
            document.getElementById('cancelSessionId').value = sessionId;
        });

         const cancelForm = document.getElementById('cancelForm');
        cancelForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(cancelForm);
            const sessionId = formData.get('id');

            // 顯示載入狀態
            const submitBtn = cancelForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = '處理中...';

            fetch('/Member/CancelPrivate', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                // 關閉確認 Modal
                const confirmModal = bootstrap.Modal.getInstance(cancelConfirmModal);
                confirmModal.hide();

                // 不管成功或失敗，都直接重新載入頁面
                window.location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                // 關閉確認 Modal
                const confirmModal = bootstrap.Modal.getInstance(cancelConfirmModal);
                confirmModal.hide();
                // 即使發生錯誤也重新載入頁面
                window.location.reload();
            });
        });
    });
</script>